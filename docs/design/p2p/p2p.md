# P2P network

## Design objective

FISCO BCOS P2P model, with basic functions for efficient, commonly-used and safe internet communication, supports unicast, multicast and broadcast of blockchain messages, sychronizes nodes status and adapts multiple protocols.

## P2P main functions

- Blockchain node identification

The nodes on blockchain are uniquely identified by node ID, which is used for addressing nodes.

- Network connection management

It maintains TCP persistent connection between nodes, automatically disconnect and reconnect when connection exceptions occur.

- Messaging

Messages can be unicasted, multicasted and broadcasted among nodes on blockchain.

- Status syncing

Node status can be synchronized on blockchain.

## Blockchain node ID

Node ID is generated by the public key of ECC algorithm. Each node owns one and unique ECC key pair, as each node is identified by one and only node ID.

Usually, there files are needed when adding a node to blockchain network:

- node.key key of node in ECC format
- node.crt node certificate issued by CA
- ca.crt CA certificate provided by CA

Besides a unique node ID, nodes can follow Topic for addressing.

Node addresing:

- Addressing by node ID

To locate a node by its node ID.

- Addressing by Topic

To locate a group of nodes that follows some Topic.

## Network Connection Management

Blockchain nodes will automatically start and maintain TCP permanent connection, or reconnect when there is exception in system and network.

CA certificate will be used to verify nodes during connection.

### Connection process

```eval_rst
.. mermaid::

    sequenceDiagram
        participant Node A
        participant Node B

        Node A->>Node A: load key and certificate
        Node B->>Node B: load key and certificate
        Node A->>Node B: start connection
        Node B->>Node A: connected 
        Node B->Node A: start SSL shaking
        Node A->>Node A: acquire public key from certificae as node ID
        Node B->>Node B: acquire public key from certificae as node ID
        Node B->Node A: shaking succeeded, start SSL connection

```

## Messaging

Messaging among nodes supports unicast, multicast and broadcast.

- Unicast, one node sends messages to another node, addressing through node ID.
- Mulitcast, one node sends messages to a group of nodes, addressing through Topic.
- Broadcast, one node sends messages to all nodes.

### Unicast process

```eval_rst
.. mermaid::

    sequenceDiagram
        participant Node A
        participant Node B

        Node A->>Node A: filter nodes by node ID
        Node A->>Node B: send message
        Node B->>Node A: return message

```

### Multicast process

```eval_rst
.. mermaid::

    sequenceDiagram
        participant Node A
        participant Node B
        participant Node C
        participant Node D

        Node A->>Node A: 根据Topic 1，选择节点B、C
        Node A->>Node B: 发送消息
        Node A->>Node C: 发送消息
        Node B->>Node B: 根据Topic 2，选择节点C、D
        Node B->>Node C: 发送消息
        Node B->>Node D: 发送消息
        Node C->>Node C: 根据Topic 3，选择节点D
        Node C->>Node D: 发送消息

```

### 广播流程

```eval_rst
.. mermaid::

    sequenceDiagram
        participant 区块链节点A
        participant 区块链节点B
        participant 区块链节点C
        participant 区块链节点D

        区块链节点A->>区块链节点A: 遍历所有节点ID
        区块链节点A->>区块链节点B: 发送消息
        区块链节点A->>区块链节点C: 发送消息
        区块链节点A->>区块链节点D: 发送消息
        区块链节点B->>区块链节点B: 遍历所有节点ID
        区块链节点B->>区块链节点C: 发送消息
        区块链节点B->>区块链节点D: 发送消息
        区块链节点C->>区块链节点C: 遍历所有节点ID
        区块链节点C->>区块链节点D: 发送消息

```

## 状态同步

每个节点会维护自身的状态，并将状态的Seq在全网定时广播，与其它节点同步

```eval_rst
.. mermaid::

    sequenceDiagram
        participant 区块链节点A
        participant 区块链节点B

        区块链节点A->区块链节点B: 广播seq
        区块链节点A->>区块链节点A: 判断节点B的seq是否变化
        区块链节点A->>区块链节点B: seq变化，发起状态查询请求
        区块链节点B->>区块链节点A: 返回节点状态
        区块链节点A->>区块链节点A: 更新节点B的状态和seq

```
